## Objectives

* Explain what Angular services are.
* Explain the difference between Angular services and factories.
* Build a custom Angular service.
* Inject a custom Angular service into an Angular controller.

## A brief introduction

As we start building larger applications with multiple controllers, not only is our code per controller becoming larger, but we are starting to face with a new problem. How do we share data, properties and methods between controllers?

## So many choices:

When you start learning about services you will see many different things around creating a `service`, `factory`, or `provider`. These are all commonly called services and one of them is called service...it's a bit tricky, but for the most part these three things serve very similar purposes and they are only a bit different. We will compare and contrast these later, but for now, let's learn a little more about how services work in Angular:

Angular services are components that serve the purpose of abstracting data logic away from your controllers, directives, and even other services.
For example, a request to your server for data or hitting a pubic api is something that would be placed in a service.
Some collection of methods or logic that is used in multiple controllers would be more DRY living in a service that is then referenced by all the controllers that need that logic.
Any data stored in a controller is lost when you change to another controller.
Services on the other hand will persist data between controllers. This is done though something called the singleton pattern.
Don't worry too much about singletons for now. That will be a pattern that will pop up again when you start diving into more Object Oriented Programing.

Services act as internal APIs that are added to your code via dependency injection. From the[ angular docs](https://docs.angularjs.org/guide/services):

> Angular services are:
>
> * Lazily instantiated ‚Äì Angular only instantiates a service when an application component depends on it.
> * Singletons ‚Äì Each component dependent on a service gets a reference to the single instance generated by the service factory.


## The "service" service and the "factory" service

The end result of a factory and service is the same: a *singleton instance* that can be used throughout our application. The main difference between a factory and a service comes down to how they are defined.

### *Factory* Service
Using the factory API, you pass in the name of your service and a callback function that returns an object.

Behind the scenes, Angular calls the function and sets the returned object as the *singleton instance* that will be injected into our controllers.

```js
angular
  .module("learnServices", [])
  .factory('personFactory', function(){
    return {
      name: "Matt",
      job: "Instructor",
      sayHi: function(){
        return "Hello!"
      }
    }
  }).controller('personController', function(personFactory){
    // I now have access to all the methods/properties returned from the personFactory!
  })
```

### *Service* Service
Using the service API, you create a constructor function using the `this` syntax to attach properties/methods to the constructor.

Behind the scenes, Angular calls `new` on your function to create an instance. This instance is set as the *singleton instance* that will be injected into our controllers.

Here is the same service defined using the service API:

```js
angular
  .module("learnServices", [])
  .service('personService', function(){
    this.name = "Matt";
    this.job = "Instructor";
    this.sayHi = function(){
      return "Hello!"
    }
  }).controller('personController', function(personService){
    // I now have access to the personService!
  });
```

A provider is the most complex method and is used less frequently. It is a factory that can be configured before the application starts, which allows for more flexibility, but for the applications we are going to build, you will not need this level of complexity.

## So which one??

For right now we are going to focus on factories. They are a bit easier to reason about having not gotten into OOP and instantiation yet. Many articles will lean towards factories, but with the new ES2015 syntax, services are becoming more preferable. Be aware of both of these and the differences between them.

### Answer the following questions:

- What is a service? What problem do they solve for us?
- What is the difference between a factory and a service?
- Name at least 3 angular built in services that we have used so far.

## Creating our first Service

We are going to start off by creating a `service.js` file to define our service in. While we're at it, let's not forget to throw a script for it in our `index.html` file... `<script src="services.js"></script>`

Remember from above that one of the reasons we use services is seperation of concerns, so creating a new file for it makes sense.

```js
(function() {
  'use strict';

  const app = angular.module('todoApp');

  app.factory('personTodos', personTodos);

  function personTodos() {
    return {
      test: function() {
        console.log('winner winner vegan tofurkey dinner!');
      },
    }
  };

})();
```

Back in our controller, we inject this service like such:

```js
app.controller('TodoListCtrl', TodoListCtrl);

TodoListCtrl.$inject = ['$http', 'personTodos'];
// ----------------------------------^^^

// ------------------------------vvv
function TodoListCtrl($http, 'personTodos') {
  this.todoToAdd = '';
  this.todos = [];

  personTodos.test(); // üëàüèΩ

  this.addTodo = (person) => {
    return $http.post(`${server}/${person.id}/is-todos`, {
      completed: false,
      text: this.todoToAdd
    })
    .then((res) => {
      person.todos.push(res.data);
      this.todoToAdd = '';
    })
    .catch((err) => {
      throw err;
    });
  };
}
```

If you have everything wired up correctly, when you reload the page you should see your message in the console. üå±üêî <-- That's a vegetable turkey!

The `addTodo` method is making an http request to our API. That sounds prime for some.. re-factorying

![please clap](https://media.giphy.com/media/l0NwPo3VHujpJDI4w/giphy.gif)

Now that we know it's working let's replace that `test` method with an `addTodo` method. You can go ahead and just pull all the code from the `addTodo` method in your controller for this. We'll be changing just a couple things.
  * it will now also take the `todoText` as a second parameter.
  * in the *then* we will get rid of the `push` to `res.data` and just return the response data instead.
  * inject `$http` into our service.

```js
(function() {
  'use strict';

  const = app = angular.module('todoApp');

  app.factory('personTodos', personTodos);
  PersonTodos.$inject = ['$http'];

  function personTodos($http) {
    return {
      addTodo: (person, todoText) => {
        return $http.post(`${server}/${person.id}/is-todos`, {
          completed: false,
          text: todoText
        })
        .then((res) => {
          return res.data;
        })
        .catch((err) => {
          throw err;
        });
      },
    }
  };

})();
```

In our controller we will want to make a few changes as well.
  * our controller will no longer need `$http` injected into it.
  * we can swap out that `$http.post` request with a call to our factory
    method instead.
  * update our *then* push the `todo` and clear text in `todoToAdd`.

```js
function TodoListCtrl('personTodos') {
  this.todoToAdd = '';
  this.todos = [];

  this.addTodo = (person) => {
    personTodos.addTodo(person, this.todoToAdd)
      .then((todo) => {
        person.todos.push(todo);
        this.todoToAdd = '';
      })
      .catch((err) => {
        throw err;
      });
  };
}
```

Should be good to go. Let's test out adding a todo.

Moving on to the next controller, `PeopleCtrl`. The first thing we have
in there that can be refactored into our factory is the `addPerson`
funciton. We can start off by creating a new factory called `people` in
our `services.js` file.

```js
app.factory('people', people);

function people() {
  return {
    addPerson: () => {
      console.log('things and stuff');
    }
  }
}
```

We won't be needing `$http` in our controller anymore so let's swap that
out for our `people` factory.

```js
PeopleCtrl.$inject = ['people'] // people in $http out

function PeopleCtrl(peopleSvc) {
  this.nameToAdd = '';
  this.people = [];

  peopleSvc.addPerson() // should log out our stuffs!

  // more codez...
}
```

With that all wired up, we can move on to pulling the code from our
controllers `addPerson` and paste it into our factory.
  * inject `$http` into our factory.
  * provide a `name` parameter for our method.
  * we will want to return our `$http` request.
  * we can swap out `this.nameToAdd` with the one that gets passed in.
  * at the top of our `services.js` file create a const pointing at the
    server url called `server`.
  * we will fully update our promise handler.
    * create a person constant set to `res.data`.
    * create a `todos` property on person set to an emptry array.
    * then return `person`.

```js
const server = 'https://galvanize-todos.herokuapp.com/is-persons';

app.factory('people', people);
people.$inject = ['$http'];

function people($http) {
  return {
    addPerson: (name) => {
      return $http.post(server, { name })
        .then((res) => {
          const person = res.data;
          person.todos = [];
          return person;
        })
        .catch((err) => {
          throw err;
        });
    }
  }
}
```

Annnnnd, back to the controller...
  * replace the `$http` request with our factory method.
  * pass the `nameToAdd` to our method.
  * update our `people` array with our new `person`.
  * clear the `nameToAdd` field.

```js
function PeopleCtrl(peopleSvc) {
  this.nameToAdd = '';
  this.people = [];

  this.addPerson = () => {
    peopleSvc.addPerson(this.nameToAdd)
      .then((person) => {
        this.people.push(person);
        this.nameToAdd = '';
      })
      .catch((err) => {
        throw err;
      });
  }
}
```

### Resources

[Singleton Design Pattern](http://robdodson.me/javascript-design-patterns-singleton/)
[Singleton Wiki](https://en.wikipedia.org/wiki/Singleton_pattern)
[Putting Angular Code in the Right Place](http://datamelon.io/blog/2016/putting-angular-code-in-the-right-place.html)

More about the differences between factories and services:

[ng-newsletter: The short guide to service definitions](http://www.ng-newsletter.com/25-days-of-angular/day-1)
[Service VS Factory - ONCE AND FOR ALL](http://blog.thoughtram.io/angular/2015/07/07/service-vs-factory-once-and-for-all.html)
[AngularJS: Factory vs Service vs Provider](http://tylermcginnis.com/angularjs-factory-vs-service-vs-provider/)
[AngularJS Providers Explained](https://gist.github.com/demisx/9605099)
